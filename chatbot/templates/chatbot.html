{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsive Chat Interface</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <style>
    #chat_parent_container{
      padding: 2rem;
    }

    .chat-container {
      background-color: #f4f5f6;
      height: 70vh;
      overflow-y: auto;
      font-size: clamp(0.9rem, 0.8vw, 2rem); 
    }
    .message {
      position: relative;
      margin-bottom: 10px;
    }

    .message-body{
      position: relative;
    }

    .message.bot .message-body {
      background-color: #dbdbdb;
      color: #333;
    }
    .message.user .message-body {
      background-color: #007bff;
      color: #fff;
    }

    .bot .message-body{
        border-radius: 1rem 1rem 1rem 0;
    }

    .user .message-body{
        border-radius: 1rem 1rem 0 1rem;
        width: fit-content;
    }

    .user{
      padding-left: 10vw;  
    }

    .bot{
      padding-right: 10vw;  
    }

    .user .message-body.p-2{
      margin-right: 0;
      margin-left: auto;
    }

    .bot .message-body.p-2{
      margin-right: auto;
      margin-left: 0;
    }

  </style>
</head>
<body>

    {% include 'navbar.html' %}
  <div id="chat_parent_container" class="container" style="position: relative;">
    <div class="row">
      <h1 class="mt-5 mb-3">Chat Interface</h1>
    </div>
    <div class="chat-container border rounded p-3">
      <!-- <div class="row" style="background-color: #007bff; position: fixed; width: calc(200px - 100%);">

      </div> -->
      <div class="message user">
        <div class="message-body p-2">
          <span>
            Hello! My name is samuel this is dummy text. I need a long text to test the message-body container.
          </span>
        </div>
      </div>
      <div class="message bot">
        <div class="message-body p-2">
          <span>
            Swift Courier is a package delivery service that allows customers to send small packages quickly and efficiently within their service areas. They use motorcycles to ensure timely delivery of items such as documents, small electronics, and gifts that fit within motorcycle delivery constraints. To use their service, customers can place an order through their app by entering the pickup and delivery details, choosing a delivery option, and a brief description of the package to deliver. Swift Courier offers expedited and same-day delivery options in select areas, and scheduled deliveries can also be arranged. Customers can track their package in real-time through the app or website and receive updates via push notifications or SMS[doc3].
          </span>
        </div>
      </div>
      <div class="message user">
        <div class="message-body p-2">
          <span>
            Hello! My name is samuel this is dummy text. I need a long text to test the message-body container.
          </span>
        </div>
      </div>
      <div class="message bot">
        <div class="message-body p-2">
          <span>
            Swift Courier is a package delivery service that allows customers to send small packages quickly and efficiently within their service areas. They use motorcycles to ensure timely delivery of items such as documents, small electronics, and gifts that fit within motorcycle delivery constraints. To use their service, customers can place an order through their app by entering the pickup and delivery details, choosing a delivery option, and a brief description of the package to deliver. Swift Courier offers expedited and same-day delivery options in select areas, and scheduled deliveries can also be arranged. Customers can track their package in real-time through the app or website and receive updates via push notifications or SMS[doc3].
          </span>
        </div>
      </div>
      <div class="message user">
        <div class="message-body p-2">
          <span>
            Hello! My name is samuel this is dummy text. I need a long text to test the message-body container.
          </span>
        </div>
      </div>
      <div class="message bot">
        <div class="message-body p-2">
          <span>
            Swift Courier is a package delivery service that allows customers to send small packages quickly and efficiently within their service areas. They use motorcycles to ensure timely delivery of items such as documents, small electronics, and gifts that fit within motorcycle delivery constraints. To use their service, customers can place an order through their app by entering the pickup and delivery details, choosing a delivery option, and a brief description of the package to deliver. Swift Courier offers expedited and same-day delivery options in select areas, and scheduled deliveries can also be arranged. Customers can track their package in real-time through the app or website and receive updates via push notifications or SMS[doc3].
          </span>
        </div>
      </div>
      <div class="message user">
        <div class="message-body p-2">
          <span>
            Hello! My name is samuel this is dummy text. I need a long text to test the message-body container.
          </span>
        </div>
      </div>
      <div class="message bot">
        <div class="message-body p-2">
          <span>
            Swift Courier is a package delivery service that allows customers to send small packages quickly and efficiently within their service areas. They use motorcycles to ensure timely delivery of items such as documents, small electronics, and gifts that fit within motorcycle delivery constraints. To use their service, customers can place an order through their app by entering the pickup and delivery details, choosing a delivery option, and a brief description of the package to deliver. Swift Courier offers expedited and same-day delivery options in select areas, and scheduled deliveries can also be arranged. Customers can track their package in real-time through the app or website and receive updates via push notifications or SMS[doc3].
          </span>
        </div>
      </div>
    </div>
    <form id="chat-form" class="mt-3">
      <div class="input-group">
        <input type="text" id="message-input" class="form-control" placeholder="Type your message..." autocomplete="off">
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </div>

  {% include 'footer.html' %}

  <script>
    const form = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatContainer = document.querySelector('.chat-container');

    // setup chat scoket
    var id = "{{ user_id|safe }}".replace(/[^0-9a-fA-F]/g, '');

    // will attempt to establish connection only if user is authenticated
    if (id != ""){
      const chatSocket = new WebSocket( `ws://${window.location.host}/ws/chat/${id}/` );
      
      // socket open
      chatSocket.onopen = function (e) {
          console.log('chat socket successfully connected.');
      };
  
      //socket close
      chatSocket.onclose = function (e) {
          console.log('chat socket closed unexpectedly');
      };

      // server sending message to user
      chatSocket.onmessage = function (e) {
          const data = JSON.parse(e.data);
          const message = data.message;
          appendMessage("bot", message );
      };
  
      // user sending message to server
      function sendMessage(message) {
        chatSocket.send(JSON.stringify({ 'message': message }));
      }
    }


    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const message = messageInput.value.trim();
      if (message === '') return;
      appendMessage('user', message);
      messageInput.value = '';

      // send message to Nova
      sendMessage(message)
    });

    function appendMessage(sender, message) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message', sender);
      messageElement.innerHTML = `<div class="message-body p-2"><span>${message}</span></div>`;
      chatContainer.appendChild(messageElement);

      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

  </script>
</body>
</html>