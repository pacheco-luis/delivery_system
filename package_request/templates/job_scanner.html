{% extends 'base.html' %}
{% block title %}Job Scanner{% endblock title %}
{% block content %}

{% block head %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
{% endblock head %}

<div class="container" style="max-width: 1200px; margin: 0 auto; margin: 0 80px;">
    <h1>Job Scanner</h1>

    <div id="reader"></div>
    <div id="result"></div>
</div>

<script>
    const scanner = new Html5QrcodeScanner('reader', {
        qrbox: {
            width: 250,
            height: 250
        },
        fps: 20,
    });
    scanner.render(success, error);

    function success(result) {
        // Create a form to send package ID to Django view
        const form = document.createElement('form');
        form.setAttribute('method', 'post');
        form.style.display = 'none';

        // Create an input field for package ID
        const input = document.createElement('input');
        input.setAttribute('type', 'hidden');
        input.setAttribute('name', 'package_id');
        input.setAttribute('value', result);

        // Append input field to form
        form.appendChild(input);

        // Add CSRF token to form
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.setAttribute('type', 'hidden');
            csrfInput.setAttribute('name', 'csrfmiddlewaretoken');
            csrfInput.setAttribute('value', csrfToken);
            form.appendChild(csrfInput);
        }

        // Append form to document body
        document.body.appendChild(form);

        // Submit form
        form.submit();

        scanner.clear();
        document.getElementById('reader').style.display = 'none';
    }

    function error(err) {
        // console.error(err);
    }

    // Function to get CSRF token from cookies
    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length, cookie.length);
            }
        }
        return null;
    }
</script>

{% endblock content %}